<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL,deleteObject } from "https://www.gstatic.com/firebasejs/9.8.1/firebase-storage.js";
    
    let imageUploaded = false;
      
    const firebaseConfig = {
      apiKey: "AIzaSyAZWaP81L4cH9OroQVlXQDC8KZjr7PaQ10",
      authDomain: "lyricallly.firebaseapp.com",
      projectId: "lyricallly",
      storageBucket: "lyricallly.appspot.com",
      messagingSenderId: "1024559380495",
      appId: "1:1024559380495:web:50f3ab1225ae00ffcacb7a",
      measurementId: "G-BPMQZ1H4FQ",
    };
      
    // Initialize Firebase
    initializeApp(firebaseConfig);
    
    const storage = getStorage();
  
    let previousProfile = jar.get('previousProfile');
  
    jar.remove('previousProfile')
  
    // Remove the previous profile picture
    // if any kind of error occured while signing
    if(previousProfile)
    {
      previousProfile = '/profile_pictures/' + previousProfile;
      
      const deleteRef = ref(storage, decodeURI(previousProfile));
      
      deleteObject(deleteRef).then(() => {
        console.log('File deleted successfully')
      })
    }
  
    let choice = false;
  
    $('#profile').on('change',e => {
      const image = e.target.files[0];
      let uuid = self.crypto.randomUUID();
  
      Swal.fire({ title: 'Do you wan\'t to upload the image', icon: 'question', showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'Yes, upload the image!'})
      .then((result) => {
        if (result.isConfirmed) {
          const name = `/profile_pictures/${uuid}${image.name}`;
          const imagesRef = ref(storage, name);
        
          uploadBytes(imagesRef, image).then(async (snapshot) => {
            try
            {
              const url = await getDownloadURL(ref(storage, name));
              imageUploaded = true;
  
              $('#profile_url').attr('value', url);
              $('#previousProfile').attr('value', `${uuid}${image.name}`);
  
              imageUploaded = true;
  
              Swal.fire( 'Success', "Image uploaded successfully", 'success' )
            }
            catch(ex)
            {
              Swal.fire({ icon: 'error', title: 'Error', text: "Error while uploading the image"})

            }
          });
        }
      }) // end then
    })
  
    $('#signup').on('click', e => {
      e.preventDefault();
  
      if (!imageUploaded) return Swal.fire({ icon: 'info', title: 'Info', text: "Upload the profile picture first."})
  
      $("#form").submit();
    })
      
  </script>
  